<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xml:lang="en-us" lang="en-us">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<meta name="copyright" content="(C) Copyright 2005"/>
<meta name="DC.rights.owner" content="(C) Copyright 2005"/>
<meta name="DC.Type" content="reference"/>
<meta name="DC.Title" content="Developing and running applications that use the DPS Toolkit"/>
<meta name="DC.Format" content="XHTML"/>
<meta name="DC.Identifier" content="spldoc_page"/>
<link rel="stylesheet" type="text/css" href="../../html/commonltr.css"/>
<link rel="stylesheet" type="text/css" href="../../html/spldoc.css"/>
<title>Developing and running applications that use the DPS Toolkit</title>
</head>
<body id="spldoc_page">


<h1 class="title topictitle1">Developing and running applications that use the DPS Toolkit</h1>

<div class="body refbody">
<div class="section">
<p class="p">
<a class="xref" href="../toolkits/toolkits.html">Streams DPS Toolkit</a> &gt; <a class="xref" href="tk$com.ibm.streamsx.dps.html">com.ibm.streamsx.dps 4.1.8</a> &gt; Developing and running applications that use the DPS Toolkit</p>

</div>


<div class="section">
<div class="p">To create applications that use the DPS Toolkit, you'll need to:
<ol class="ol">
<li class="li">  Install IBM InfoSphere Streams.  Configure the product environment variables by entering the following command: 
<pre class="pre codeblock">
  source product-installation-root-directory/4.2.0.0/bin/streamsprofile.sh

Download the most recent version of the DPS toolkit from here and extract it in your IBM Streams development machine.
https://github.com/IBMStreams/streamsx.dps    
</pre>

</li>

<li class="li">
<div class="p">  Ensure that all of the following additional RPMs required by the DPS toolkit are present on your system: 
<ul class="ul">
<li class="li"> curl</li>

<li class="li"> curl-devel</li>

<li class="li"> lua</li>

<li class="li"> lua-devel</li>

<li class="li"> openssl-devel</li>

<li class="li"> openldap-devel</li>

<li class="li"> cyrus-sasl</li>

<li class="li"> cyrus-sasl-devel</li>

<li class="li"> ibverbs</li>

<li class="li"> ibverbs-devel </li>

</ul>

</div>
</li>

<li class="li"> Install and configure an external key-value data store that is supported by DPS.</li>

<li class="li"> Configure the DPS toolkit to connect to the data store from step 3.  Copy the DPS toolkit sample configuration file from <tt class="ph tt">&lt;YOUR_DPS_TOOLKIT_DIRECTORY&gt;/samples/advanced/01_using_no_sql_db_in_spl_custom_and_cpp_primitive_operators/etc/no-sql-kv-store-servers.cfg</tt> to <tt class="ph tt">your-project-directory/etc/no-sql-kv-store-servers.cfg</tt> and edit the file as follows:
<ul class="ul">
<li class="li"> For Redis in non-cluster mode: <tt class="ph tt">redis</tt> should be the first line in the configuration file. Then specify the Redis server/IP address and port number separated by a colon, e.g. <tt class="ph tt">Machine1:7002</tt>.  Each additional server should be specified on a new line.  If you prefer to use the Unix domain socket instead of TCP, you can simply specify <tt class="ph tt">unixsocket</tt> instead of a server name. If you decide to use a unix domain socket, you must also ensure that your redis.conf file on the server side is configured properly for a unix domain socket pointing to <tt class="ph tt">/tmp/redis.sock</tt> file.      </li>

<li class="li"> For Redis in cluster mode: <tt class="ph tt">redis-cluster-plus-plus</tt> should be the first line in the file, followed by the server name or IP address and a port number for one of the master Redis nodes that is active in your Redis cluster. For example: <tt class="ph tt">Machine1:30001</tt>.</li>

<li class="li"> It is suggested that you read the commentary section at the top of that configuration file to understand various options available for configuring your chosen no-sql database.</li>

<li class="li"> Each time you create a new SPL project, copy the configuration file from the example provided in the DPS toolkit to the /etc directory inside of your SPL project directory.  Make any configuration changes needed to the file, based on your application's needs. </li>

<li class="li"> See the sample configuration file for additional examples.</li>

</ul>
</li>

</ol>

</div>

</div>

<div class="section"><h2 class="title sectiontitle">Using the toolkit in SPL applications
</h2>

<p class="p">All the functionality of the toolkit is available via the native functions in the <tt class="ph tt">com.ibm.streamsx.store.distributed</tt> and <tt class="ph tt">com.ibm.streamsx.lock.distributed</tt> namespaces. You need to include these namespaces in your SPL application via a use directive.  See the "Getting Started" section below and the native function documentation has more details on how to use the toolkit within applications written in SPL. If you have a C++ or Java operator or function that uses the DPS toolkit, your SPL application graph must also include an instance of the <a class="xref" href="op$com.ibm.streamsx.store.distributed$DPSAux.html">DPSAux</a> operator.  This operator does not require any additional configuration but must be present in order for your application to work correctly.  See the <tt class="ph tt">DPSUsageFromJava</tt> sample for an example.  
</p>

</div>

<div class="section"><h2 class="title sectiontitle">Using the toolkit in Java applications
</h2>

<p class="p">Ensure that <tt class="ph tt">&lt;dps_toolkit_home&gt;/impl/java/lib/dps-helper.jar</tt>, which contains the Java implementation of the DPS functions is accessible to your application.  Packages of interest are <tt class="ph tt">com.ibm.streamsx.dps</tt> and <tt class="ph tt">com.ibm.streamsx.dl</tt>. See the "Getting Started" section below and the  <a class="xref" href="../../../javadoc/dps/index.html">Javadoc</a> for details on using the API from operators written in Java.
</p>

<div class="p"><strong class="ph b">Note regarding fusing Java operators:</strong>  Fusing two or more Java operators that utilize the Java DPS API requires that each operator have the same class path and the <tt class="ph tt">@SharedLoader</tt> annotation in its class definition. For example:
<pre class="pre codeblock">
PrimitiveOperator(name="MyJavaOperator", namespace="com.ibm.demo",  description="Java Operator MyJavaOperator")
@SharedLoader(true)
public class MyJavaOperator extends AbstractOperator {
	...
}
</pre>


</div>

</div>

<div class="section"><h2 class="title sectiontitle">Using the toolkit in C++ applications
</h2>

<p class="p">Include the C++ header file <tt class="ph tt">DistributedProcessStoreWrappers.h</tt> found in <tt class="ph tt">impl/include</tt>.  This is the main entry point for the C++ functions, which are in the C++ namespace <tt class="ph tt">com::ibm::streamsx::store::distributed</tt>. 
</p>

</div>

<div class="section"><h2 class="title sectiontitle">Getting Started
</h2>

<p class="p">The following snippets demonstrate the basic usage of the toolkit from SPL and Java. Usage from C++ is very similar to the SPL example below.
</p>

<p class="p">SPL:
</p>

<div class="p">
<pre class="pre codeblock">
rstring dummyRstring = "";
uint32 dummyUint32 = 0u;
mutable uint64 err = 0ul;
mutable uint64 dbStore_handle = 0ul;
dbStore_handle = dpsCreateStore("myDBStore1", dummyRstring, dummyUint32, err);

if (err == 0ul ) { //no error occurred
	 //create lock for the store
	mutable uint64 lock_id = dlCreateOrGetLock("My db store lock", err);
	// Acquire the newly created lock, specifying a lease time and maximum time to wait to acquire the lock.
	float64 max_wait = 10.0;
	float64 lease_time = 10.0;
	dlAcquireLock(lock_id, lease_time, max_wait, err);
	//add a key/value pair to the store
	mutable boolean result = true;
	rstring key = "IBM";
	uint32 value = 399;
	err = 0ul;
	result = dpsPut(dbStore_handle, key, value, err);
	
	if (err != 0ul) {
		//use  dpsGetLastStoreErrorCode() and  dpsGetLastStoreErrorString() as needed
	}
	// finished our store operations, release the lock
	err = 0ul;
	dlReleaseLock(lock_id, err);	
}
</pre>


</div>

<p class="p">Java:	
</p>

<div class="p">
<pre class="pre codeblock">
StoreFactory sf = DistributedStores.getStoreFactory();
Store store = null;

try {
   //specify the SPL types for the keys and values in the store
   String keyType = "rstring";
   String valueType = "int32";
   store = sf.createOrGetStore("Java Test Store1", keyType, valueType);
} catch (StoreFactoryException sfe) {
	// use	sfe.getErrorCode() and  sfe.getErrorMessage()) for more info
}

...
//once ready to access the store,
//get the lock for the store, may have previously been created
   LockFactory lf = DistributedLocks.getLockFactory(); 
   Lock myLock = lf.createOrGetLock("Lock_For_Test_Store1");

// Acquire the lock
try {
 	myLock.acquireLock();
} catch (LockException le) {
	System.out.print("Unable to acquire the lock named 'Lock_For_Test_Store1'");
	System.out.println(" Error = " + le.getErrorCode() + ", Error msg = " + le.getErrorMessage());
    throw le;
}

//perform store operations
store.put("IBM", 39);
store.put("Lenovo", 50);
//release the lock  when finished
myLock.releaseLock();
</pre>


</div>

<p class="p">Note that error checking in the above examples is minimal.
</p>

</div>

<div class="section"><h2 class="title sectiontitle">Error Handling in C++ and SPL
</h2>

<p class="p">Most C++ functions include a mutable <strong class="ph b">err</strong> parameter that will contain the result of executing the function.  If an error occurs, this variable's value will be non-zero. It is the caller's responsibility to provide a mutable parameter to contain the error code and check its value afterwards.
</p>

<div class="p">In addition, there are functions that can be called when an error occurs to return the last error code and a message describing the error.  The correct function to call after an operation depends on the operation that was last executed.
<ul class="ul">
<li class="li"> For errors relating to the store functions, use <tt class="ph tt">dpsGetLastStoreErrorCode()</tt> and <tt class="ph tt">dpsGetLastStoreErrorString()</tt>.</li>

<li class="li"> For errors related to the TTL functions, use <tt class="ph tt">dpsGetLastStoreErrorCodeTTL()</tt> and <tt class="ph tt">dpsGetLastStoreErrorStringTTL()</tt>.</li>

<li class="li"> For locking related errors, use <tt class="ph tt">dlGetLastDistributedLockErrorCode()</tt> and <tt class="ph tt">dlGetLastDistributedLockErrorString()</tt>.</li>

</ul>

</div>

<p class="p">The following example shows how to check for errors, after a function call, in this case, after creating a lock:
</p>

<div class="p">
<pre class="pre codeblock">
mutable uint64 err = 0ul;
mutable uint64 lock_id = dlCreateOrGetLock("My Sentinel Lock1", err);

if (err != 0ul) {
	rstring msg = dlGetLastDistributedLockErrorString();
	uint64 rc = dlGetLastDistributedLockErrorCode();
	printStringLn("Error creating lock, rc = " + (rstring)(rc) + ", msg =" + msg );
}
</pre>


</div>

</div>

<div class="section"><h2 class="title sectiontitle">Additional Examples
</h2>

<p class="p">To specifically learn how to call the DPS APIs from SPL native functions, C++ and Java primitive operators, see the samples included in <tt class="ph tt">&lt;STREAMS_INSTALL&gt;/samples/com.ibm.streamsx.dps</tt> or in <tt class="ph tt">&lt;YOUR_DPS_TOOLKIT_DIRECTORY&gt;/samples</tt> directory. The <tt class="ph tt">advanced</tt> sub-directory there contains examples that showcase bulk of the available DPS APIs.
</p>

</div>

<div class="section"><h2 class="title sectiontitle">Reference information
</h2>

<p class="p"><a class="xref" href="../../../javadoc/dps/index.html">DPS Java API Reference</a>
</p>

</div>

</div>


</body>
</html>